// so edgy xD

/* 
									  .,c="""  _JLccccc,
								  ,r="     ,,-'         "=c
							   ,J"    ,c$?$ $ `$c          `=,
							,c"'  ,J"" J ( j'   "$.           "c,
	 ?????????????""""""???"=hcJ$"    JL   `r    `$r             "$q
	 `.`.`.`.`.`.`.`.`.`.`.`.`J"     j'L   `L   \  ?c               "g
	 `.`.`.`.`.`.`.`.`.`.`.`.J      j'`?c   ?.   t  `$.               `=hc,;c???
	 `.`.`.`.`.`.`.`.`.`.`_,$      z'.`.?L   $   `h   "=c,      ,cJ????""`.`.`.`
	 `.`.`.`.`.`,cPP?"""'? J    ;,?.`z$$h`"$.'L3, `L  $    "" $`.`.`.`.`.`.`.`.`
	 `.`.`.,c??"        ,f $   / $.`.,,,`"=`?h`?$c    `r 3r  .$`.`.`.`.`.`.`.`.`
	 "hcr="             j  F  j  P.`$$$h3$,`.`???$c    `cc$r.P.`.`.`.`.`.`.,r`.`
	 `.$                ( J  d$ j'.`?.$$$$`.`.,`.`="$c.,cP"" $.`.$??"??$hc$".`.`
	 `.`h               ( $  $$ $`.`.`.""""`.J:`hJ?$h,`.$   JF.`$"      .$.`.`.`
	 `.`.?.             `j' ($$ $`.`.`.`.`.`f.`?$$$$$$r'3  J"`.J" \    .P`.`.`.`
	 `.`.`?.             $  ($' $`.`.`.`.;`.`.`.`"?$??"`$ .F',$F   L  .P.`.`.`.`
	 `.`.`.?.           j'  ($' $`.`.`.`"=cj'.`.`.`.`.`,P $'$l?F   $ j'`.`.`.`.`
	 `.`.`.`?,          `$.  ? '$`.`.`.`.`.`.`.`.`.`.`,$  $$j'j'   $z?.`.`.`.`.`
	 `.`.`.`.?,         ( $    j'`.`.J$I?$c,.`.`.`.`.J$F  $cJ      3F`.`.`.`.`.`
	 `.`.`.`.``h          j'   $h`.`.?6$cI$9;`.`.`.c$$" .$" L    .P".`.`.`.`.`.`
	 `.`.`.`.`.`?.        $   J$?,.`.`.??i???`.`.`.`$F.P$$  ?   J?.`.`.`.`.`.`,P
	 `.`.`.`.`.`."h.      $  J$$.?.`.`.`.`.`.`.`.`,$$,c'`$   L,P.`.`.`.`.`.`.,F
	 h.`.`.`.`.`.`.?h    J  J3$$.`3`.`.`.`.`.`.`.J$$"$   $   J"`.`.`.`.`.`.`,P
	 `h`.`.`.`.`.`.`.?h .F J'<$F.`.?h_.`.`.`.,c$$$$$ $  ,P J?`.`.`.`.`.`.`.,P
	   $.`.`.`.`.`.`.`.?$ J' <$`.`.`.`?=hc=?"'J$$$$" $  $.P`.`.`.`.`.`.`.`,P
		$`.`.`.`.`.`.`.`f $  <$`.`.`.`.`.`.`.;$$$$   F  $?.`.`.`.`.`.`.`.,F
		 ?.`.`.`.`.`.`.(f $. j'`.`.`.`.`.`.`.$$$P   JF JF`.`.`.`.`.`.`.`,F
		  ",.`.`.`.`.`.`$'F  J)`.`.`.`.`.`.`J$P    Jl$$?.`.`.`.`.`.`.`.,F;
		   "i`.`.`.`.`.`? $ ($.`.`.`.`.`.`.z$"    J$"J"`.`.`.`.`.`.`.`,P }     j
			?`.`.`.`.`.`.?`  P.`h`.,c`.`.`J" ,' z$"'J".`.`.`.`.`.`.`.,P j      f
			 ?.`.`.`.`.`.`h  F.`$'z?.`.`,",$" zP"`.`?`.`.`.`.`.`.`.`,P ,      j'
			  ?`.`.`.`.`.`.??'.<$$.`.`.J$"j'c$.`.`.`.`.`.`.`.`.`.`.j'  $     j .
			   $.`.`.`.`.`.`.`.$?`.`.`.`.,$?.`.`.`.`.`.`.`.`.`.`.`JF  .F    J"L
				$`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.J$   $   .P   k
				`h,c.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.,$$$   `h  P
				,P"`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`,$"$$    $ $
			  ,P.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.;$F $$r    ?c,  _c"
			,P"`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`;$'F  $$       ""
		  .$"`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.,P  $  `$$
		 J?`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`,$   $     "=,_
	   ,P`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`$$   ?         "=cccc"
	 ,$"h`.`.`.`.`.`.`.`.`.`.,cc,`.`.`.`.`.`.`.`.`.`.`.`.JP$.  `t     -c   3,
	 $`.3`.`.`.`.`.`.`.;.`.`$,c,3`.`.`.`.`.`.;;`.`.`.`.`;$ `L   $       3.  ?.
	 $$iJ`.`.`.`.`.`.`;;.`.`$?;t$).`.`.`.`.`;;;`.`.`.`.,$'  $   `L       $   $
	 ?$F;`.`.`.`.`.`.`;;.`.``$iP"`.`.`.`.`.`;;:`.`.`.`.$$   $    3.      $   3
	 `h;;,.`.`.`.`.`.`?;;`.`.`.`.`.`.`.`.`.;;3.`.`.`.`,$$  j'L    $     J"   $
	  ?;;;;,.`.`.`;;.`$;;;.`.`.`.`.`.`.`.`;;;P.`.`.`.`$$F  j ?.    `"??"    v'
	  `h;;;;;;,;;;;).`?h;;,`.`.`.`.`.`.`;;;;$`.`.`.`.f'$F  J  ?,         .$"
		?c;;;;;;;;F`.`.$h;;;,`.`.`.`.,;;;;;$'`.`.`.`f  $)  $   `"?????c=" 4r
		 ?c;;;;;;F.`.`.`?y;;;;;;;,;;;;;;;iP`.`.`.`.J'  $   $              j'
		  `"?jj$F;.`.`.`.`$y;;;;;;;;;;;jP".`.`.`.`;$   $   F              j'
			   3;;.`.`.`.`.`?hijjjjid$?".`.`.`.`.,f    $   F              j'
				h;.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`,;$'  ;F   L              P
				?h.`.`.`.`.`.`.`.`.`.`.`.`.`.`.,;;$   $    ? ,cc         $
				`$;`.`.`.`.`.`.`.`.`.`.`.`.`.`,;;;$   $     "   ?.     z"
				 ?;`.`.`.`.`.`.`.`.`.`.`.`.`.;;;;;$   `r         h.,zJ"
				  h;.`.`.`.`.`.`.`.`.`.`.`.`;;;;;;$    ?        `$
				  `h;;;,.`.`.`.`.`.`.`.`.`.`;;;;;;$     $       .F
				   $;;;;;;.`.`.`.`.`.`.`.`.,;;;;;;$      "hcc$  $
				   `h;;;;;,`.`.`.`.`.`.`.`.;;;;;;;$.           j'
					?;;;;;;;.`.`.`.`.`.`.`.;;;;;;;9L,         J'
					 ?;;;;;;;`.`.`.`.`.`.`.;;;;;;;;h "cc,__,c"
					  $;';;;;,.`.`.`.`.`.`.;;;;;;';9r
					   $;`.`.`.`.`.`.`.`.`.;;`.`;`.`?c.
						$;.`.`.`.`.`.`.`.`.;.`.`.`.`.`."c._
						 h;`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`."?c,
						 ?;;.?;`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`."=c_
						  $;.`$h.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`."c
						  ?;;`.$)`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`."h.
						   h;`.`?`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`?.
						   `C;;`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.?c
							$;;,.`.`.`.`.`.`.`;;.`.`.`.`.`.`.`.`.`.`.`.`.`.h
							?;;;;`.`.`.`.`.`.;;;;`.`.`.`.`.`.`.`.`.`.`.`.`.`h
							 h.;;;;`.`.`.`.`.;;;;';`.`.`.`.`.`.`.`.`.`.`.`.`?L
							 ?.`;;;;.`.`.`.`.`;;;;;`.`.`.`.`.`.`.`.`.`.`.`.`.3.
							  ?`.;;;;`.`.`.`.`.;;;;`.`.`.`.`.`.`.`.`.`.`.`.`.`$
							   $`.;;;;,`.`.`.`.`.;$`.`.`.`.`.`.`.`.`.`.`.`.`.``L
								$`.`;;;;.`.`.`.`.;$`.`.`.`.`.`.`.`.`.`.`.`.`.`.$
								 $;`.;;;;;.`.`.`.;9`.`.`.`.`.`.`.`.`.`.`.`.`.`.3
								  $;,`.`;;.`.`.`.;?`.`.`.`.`.`.`.`.`.`.`.`.`.`.3
								   $h;;`.`.`.`.`.;;L.`.`.`.`.`.`.`.`.`.`.`.`.`.3
								   $'"$;;;;;;;;;;;j$.`.`.`.`.`.`.`.`.`.`.`.`.`.$
								   $.```?;;;;;;jjJ?$.`.`.`.`.`.`.`.`.`.`.`.`.`.$
								  J'`.`.`"hiii?";;;?h`.`.`.`.`.`.`.`.`.`.`.`.`.$
								,$`.`.`.`.``?i;;;;;;$`.`.`.`.`.`.`.`.`.`.`.`.`j'
							   c"`.`.`.`.`.`.?$i;;;;$`.`.`.`.`.`.`.`.`.`.`.`.`$
							 .P`.`.`.`.`.`.`.`.`?iii9`.`.`.`.`.`.`.`.`.`.`.`.`f
							z?.`.`.`.`.`.`.`.`.`.`.`3).`.`.`.`.`.`.`.`.`.`.`.j'
						   J'`.`.`.`.`.`.`.`.`.`.`.`?).`.`.`.`.`.`.`.`.`.`.`.3
						 j"`.`.`.`.`.`.`.`.`.`.`.`.`.h.`.`.`.`.`.`.`.`.`.`.`.3
					   ,P`.`.`.`.`.`.`.`.`.`.`.`.`.`.$.`.`.`.`.`.`.`.`.`.`.`.3 
*/

using System;
using System.ComponentModel;
using System.IO;
using System.Linq;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Media.Imaging;
using Assembly.Helpers;
using Assembly.Helpers.Net;
using Assembly.Metro.Dialogs;
using Assembly.Windows;
using Assembly.Helpers.PostGeneration;

namespace Assembly.Metro.Controls.PageTemplates.Tools
{
	/// <summary>
	/// Interaction logic for PostGenerator.xaml
	/// </summary>
	public partial class PostGenerator
	{
		private ModPostInfo GeneratorViewModel;

		public PostGenerator()
		{
			InitializeComponent();

			GeneratorViewModel = new ModPostInfo();

			DataContext = GeneratorViewModel;
		}

		// Header Stuff
		private void btnLaunchPatcher_Click(object sender, RoutedEventArgs e)
		{
			Settings.homeWindow.AddTabModule(Home.TabGenre.Patches);
		}
		private void btnGrabPreviewImageFromXbox_Click(object sender, RoutedEventArgs e)
		{
			// Show Mask
			HeaderGrabMask.Visibility = Visibility.Visible;
			btnGrabPreviewImageFromXbox.IsEnabled = false;

			var backgroundWorker = new BackgroundWorker();
			backgroundWorker.DoWork += (o, args) =>
			{
				try
				{
					// Grab Screenshot from Xbox
					var screenshotFileName = Path.GetTempFileName();
					var screenshotPng = Path.GetTempFileName();

					if (!Settings.xbdm.GetScreenshot(screenshotFileName))
					{
						Dispatcher.Invoke(new Action(() => MetroMessageBox.Show("Not Connected", "You are not connected to a debug Xbox 360, unable to get screenshot")));
						return;
					}

					// do stuff
					var bitmapSource = DDSConversion.Deswizzle(screenshotFileName, 1204, 720, true, true);

					// convert to png
					SaveImage(screenshotPng, bitmapSource);

					// upload
					var response = Imgur.UploadToImgur(File.ReadAllBytes(screenshotPng));

					var finalString = string.Format("http://i.imgur.com/{0}.png", response);

					Dispatcher.Invoke(new Action(() => GeneratorViewModel.ModPreviewImage = finalString));
				}
				catch (Exception ex)
				{
					Dispatcher.Invoke(new Action(() => MetroException.Show(ex)));
				}
			};
			backgroundWorker.RunWorkerCompleted += (o, args) =>
			{
				HeaderGrabMask.Visibility = Visibility.Collapsed;
				btnGrabPreviewImageFromXbox.IsEnabled = true;
			};
			backgroundWorker.RunWorkerAsync();
		}

		// Image Stuff
		private void btnDeleteImage_Click(object sender, RoutedEventArgs e)
		{
			var dataContext = (ModPostInfo.Image) ((Button) sender).DataContext;
			GeneratorViewModel.Images.Remove(dataContext);
		}
		private void btnAddImage_Click(object sender, RoutedEventArgs e)
		{
			if (String.IsNullOrEmpty(txtImageToAdd.Text.Trim()) || !Uri.IsWellFormedUriString(txtImageToAdd.Text, UriKind.RelativeOrAbsolute))
			{
				MetroMessageBox.Show("Invalid Image", "You didn't type a valid image url.");
				return;
			}

			var existingImages =
				GeneratorViewModel.Images.Where(
					image => image.Url.ToLowerInvariant().Trim() == txtImageToAdd.Text.ToLowerInvariant().Trim());

			if (!existingImages.Any())
				GeneratorViewModel.Images.Add(new ModPostInfo.Image
												  {
													  Url = txtImageToAdd.Text.Trim()
												  });
			txtImageToAdd.Text = "";
		}
		private void btnGrabImageFromXbox_Click(object sender, RoutedEventArgs e)
		{
			// Show Mask
			ImageGrabMask.Visibility = Visibility.Visible;
			btnAddImage.IsEnabled = btnGrabImageFromXbox.IsEnabled = false;

			var backgroundWorker = new BackgroundWorker();
			backgroundWorker.DoWork += (o, args) =>
											{
												try
												{
													// Grab Screenshot from Xbox
													var screenshotFileName = Path.GetTempFileName();
													var screenshotPng = Path.GetTempFileName();

													if (!Settings.xbdm.GetScreenshot(screenshotFileName))
													{
														Dispatcher.Invoke(new Action(() => MetroMessageBox.Show("Not Connected", "You are not connected to a debug Xbox 360, unable to get screenshot")));
														return;
													}

													// do stuff
													var bitmapSource = DDSConversion.Deswizzle(screenshotFileName, 1204, 720, true, true);

													// convert to png
													SaveImage(screenshotPng, bitmapSource);

													// upload
													var response = Imgur.UploadToImgur(File.ReadAllBytes(screenshotPng));

													var finalString = string.Format("http://i.imgur.com/{0}.png", response);

													Dispatcher.Invoke(new Action(() => GeneratorViewModel.Images.Add(new ModPostInfo.Image
																														 {
																															 Url = finalString
																														 })));
												}
												catch (Exception ex)
												{
													Dispatcher.Invoke(new Action(() => MetroException.Show(ex)));
												}
											};
			backgroundWorker.RunWorkerCompleted += (o, args) =>
				                                       {
														   ImageGrabMask.Visibility = Visibility.Collapsed;
														   btnAddImage.IsEnabled = btnGrabImageFromXbox.IsEnabled = true;
				                                       };
			backgroundWorker.RunWorkerAsync();
		}

		// Thank Stuff
		private void btnDeleteThank_Click(object sender, RoutedEventArgs e)
		{
			var dataContext = (ModPostInfo.Thank)((Button)sender).DataContext;
			GeneratorViewModel.Thanks.Remove(dataContext);
		}
		private void btnAddMention_Click(object sender, RoutedEventArgs e)
		{
			if (String.IsNullOrEmpty(txtThankAlias.Text.Trim()) || String.IsNullOrEmpty(txtThankReason.Text.Trim()))
			{
				MetroMessageBox.Show("Invalid Mention Details", "The mention details you entered are invalid.");
				return;
			}

			var existingMentions =
				GeneratorViewModel.Thanks.Where(
					thank => thank.Alias.ToLowerInvariant().Trim() == txtThankAlias.Text.ToLowerInvariant().Trim() && thank.Reason.ToLowerInvariant().Trim() == txtThankReason.Text.ToLowerInvariant().Trim());

			if (!existingMentions.Any())
				GeneratorViewModel.Thanks.Add(new ModPostInfo.Thank
				{
					Alias = txtThankAlias.Text.Trim(),
					Reason = txtThankReason.Text.Trim(),
				});

			txtThankAlias.Text = "";
			txtThankReason.Text = "";
		}

		// Generate
		private void btnParse_Click(object sender, RoutedEventArgs e)
		{
			var postGenerator = new BlamitePostGenerator(GeneratorViewModel);
			var generatedPost = postGenerator.Parse();

			MetroPostGeneratorViewer.Show(generatedPost, GeneratorViewModel.ModAuthor);
		}

		/// <summary>
		/// Close dis mang
		/// </summary>
		public bool Close()
		{
			return true;
		}

		private void SaveImage(string filePath, BitmapSource bitmapSource)
		{
			var encoder = new PngBitmapEncoder();
			encoder.Frames.Add(BitmapFrame.Create(bitmapSource));
			using (var stream = new FileStream(filePath, FileMode.Create))
				encoder.Save(stream);
		}
	}
}